<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! Instead, edit the notebook w/the location & name as this file. -->

# `@model` Usage Patterns


<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [Key Features](#key-features)
- [Saving Models](#saving-models)
- [Loading Models](#loading-models)
  - [Loading HuggingFace Models](#loading-huggingface-models)
  - [Loading Checkpoints](#loading-checkpoints)
  - [Loading to specific path](#loading-to-specific-path)
  - [Loading Models from Keys](#loading-models-from-keys)
  - [Explicitly Loading Models](#explicitly-loading-models)
  - [Loading Models Across Flows](#loading-models-across-flows)
    - [Loading from Event Triggered Flows](#loading-from-event-triggered-flows)
    - [Loading Models with Metaflow Client API](#loading-models-with-metaflow-client-api)
    - [Loading Using Parameters](#loading-using-parameters)
  - [Loading Models After Flow Execution](#loading-models-after-flow-execution)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->



## Key Features
- Model Saving: Save models with unique identifiers and metadata
- Object Loading: Load objects saved with `current.model.save()`/ `current.checkpoint.save()`/ `current.huggingface_hub.snapshot_download()`
- Version Control: Track different versions of models to derive lineage
- Metadata Management: Attach metadata about saved/loaded models    

## Saving Models

`@model` decorator injects a `model` object in `current.` Users can call `current.model.save()` to save models. This returns a dictionary (`ModelArtifact`) containing metadata about the saved model. This dictionary contains several key pieces of information that help track and identify the saved model.

The reference contains the following keys:
```python
{
    "key": str,          # Unique storage key/path for the model
    "uuid": str,         # Unique identifier for the model
    "type": str,         # Type of artifact (always "model")
    "pathspec": str,     # Metaflow pathspec (flow/run/step/task)
    "attempt": int,      # Attempt number of the task
    "created_on": str,   # ISO format timestamp of when model was saved
    "size": int,         # Size of the saved model in bytes
    "url": str,          # Full URL/path to the stored model
    "metadata": dict,    # User-provided metadata (optional)
    "label": str        # User-provided label (optional)
}
```


```py title="temp_files/model_save_basic.py"
from metaflow import FlowSpec, step, model, current

class ModelSavingFlow(FlowSpec):
    
    @model
    @step
    def start(self):
        import uuid
        # ... Create some model files ...
            
        self.basic_model = current.model.save(
            "model.h5",
            label="basic_model",
            metadata={
                "version": "1.0",
                "accuracy": 0.95
            }
        )
        
        # ... save model into some directory ...
            
        self.directory_model = current.model.save(
            "./model_directory",
            label="keras_model",
            metadata={
                "loss": "2.0",                
            }
        )
        
        # Store just the key for later use
        self.model_key = self.directory_model["key"]
        print(f"Model key: {self.model_key}")
        self.next(self.end)


```

<CodeOutputBlock lang="bash">

```
    ...

    ...

    ...

    ...

    ...
     [7454/start/47442 (pid 2203585)] Task is starting.
    ...

    ...
     [7454/start/47442 (pid 2203585)] Model key: mf.models/models/artifacts/keras_model_5680bf7d3344450697a1f340900f4878
    ...

    ...
     [7454/start/47442 (pid 2203585)] Task finished successfully.
    ...

    ...

    ...

    ...
```

</CodeOutputBlock>

## Loading Models

The `@model` decorator can be used to load models from previous steps. The `load` argument can be given the name of the Metaflow DataArtifact that contains the return value of `current.model.save()`/ `current.checkpoint.save()` / `current.huggingface_hub.snapshot_download()`. The path to the loaded models will be accessible via `current.model.loaded`.

`current.model.loaded` is a dictionary-like object that manages loaded models. It provides access to loaded model paths and their associated metadata. The The `current.model.loaded.info` property provides access to model metadata of the loaded models.



```py title="temp_files/model_load_basic.py"
from metaflow import FlowSpec, step, model, current

class ModelSavingFlow(FlowSpec):
    
    @model
    @step
    def start(self):
        # ... Create some model files ...
            
        self.basic_model = current.model.save(
            "model.h5",
            label="basic_model",
            metadata={
                "accuracy": 0.95
            }
        )
        
        self.next(self.end)

    @model(load=["basic_model"]) # Reference the model set to self
    @step  
    def end(self): 
        model_directory = current.model.loaded["basic_model"]
            # Access the path to the file like this:
        model_path = os.path.join(
            model_directory,
            "model.h5"
        )
        print("Model Path %s Exists: %s" % (model_path, os.path.exists(model_path)))
        print("Loaded model from pathspec: %s" % current.model.loaded.info["basic_model"]["pathspec"])


```

<CodeOutputBlock lang="bash">

```
    ...

    ...

    ...

    ...

    ...

    ...

    ...
     [7455/end/47447 (pid 2204922)] Task is starting.
    ...

    ...
     [7455/end/47447 (pid 2204922)] [@model] Loading Artifact with name `basic_model` [type:model] with key: mf.models/models/artifacts/basic_model_a60f0fbea2264e558114de5a169bc73f
    ...

    ...
     [7455/end/47447 (pid 2204922)] [@model] Loaded artifact `basic_model[type:model]` in 0.05 seconds
     [7455/end/47447 (pid 2204922)] Model Path /tmp/metaflow_models_basic_model_sr3vtg2v/model.h5 Exists: True
    ...

    ...
     [7455/end/47447 (pid 2204922)] Loaded model from pathspec: ModelSavingFlow/7455/start/47445
    ...

    ...
     [7455/end/47447 (pid 2204922)] Task finished successfully.
    ...

    ...
```

</CodeOutputBlock>


### Loading HuggingFace Models


```py title="temp_files/model_load_hf_basic.py"
from metaflow import FlowSpec, step, model, current, huggingface_hub
import os

class HFModelFlow(FlowSpec):
    
    @huggingface_hub
    @step
    def start(self):
        self.hf_model = current.huggingface_hub.snapshot_download(
            repo_id="bert-base-uncased"
        )
        self.next(self.end)

    @model(load=["hf_model"]) # Reference the model set to self
    @step  
    def end(self): 
        model_path = current.model.loaded["hf_model"]
        print("Directory contents of hf_model: %s" % os.listdir(model_path))


```

<CodeOutputBlock lang="bash">

```
    ...

    ...

    ...

    ...

    ...

    ...

    ...
     [7456/end/47451 (pid 2205399)] Task is starting.
    ...

    ...
     [7456/end/47451 (pid 2205399)] [@model] Loading Artifact with name `hf_model` [type:checkpoint] with key: mf.huggingface_hub/checkpoints/artifacts/HFModelFlow/start/26ec4b03ee0e/a92ae9615600/1a471abc.0.9b5c6e8800.0
    ...

    ...
     [7456/end/47451 (pid 2205399)] [@model] Loaded artifact `hf_model[type:checkpoint]` in 27.01 seconds
     [7456/end/47451 (pid 2205399)] Directory contents of hf_model: ['README.md', 'config.json', '.gitattributes', 'LICENSE', 'flax_model.msgpack', 'tf_model.h5', 'tokenizer.json', 'pytorch_model.bin', 'vocab.txt', 'model.onnx', 'rust_model.ot', 'model.safetensors', 'tokenizer_config.json']
    ...

    ...
     [7456/end/47451 (pid 2205399)] Task finished successfully.
    ...

    ...
```

</CodeOutputBlock>

### Loading Checkpoints


```py title="temp_files/model_load_chckpt_basic.py"
from metaflow import FlowSpec, step, model, current, checkpoint
import os
import json

class CheckpointFlow(FlowSpec):
    
    @checkpoint
    @step
    def start(self):
        # ... Created some checkpoint in checkpoint_dir...
            
        self.checkpoint_foo = current.checkpoint.save(
            "./checkpoint_dir",
            metadata={
                "version": "2.0",
            }
        )
        self.next(self.end)

    @model(load=["checkpoint_foo"]) # Reference the model set to self
    @step  
    def end(self): 
        model_path = current.model.loaded["checkpoint_foo"]
        print("Directory contents of hf_model: %s" % os.listdir(model_path))


```

<CodeOutputBlock lang="bash">

```
    ...

    ...

    ...

    ...

    ...

    ...

    ...
     [7457/end/47458 (pid 2206295)] Task is starting.
    ...

    ...
     [7457/end/47458 (pid 2206295)] [@model] Loading Artifact with name `checkpoint_foo` [type:checkpoint] with key: mf.checkpoints/checkpoints/artifacts/CheckpointFlow/start/26ec4b03ee0e/a92ae9615600/54d4b3b1.0.mfchckpt.0
    ...

    ...
     [7457/end/47458 (pid 2206295)] [@model] Loaded artifact `checkpoint_foo[type:checkpoint]` in 0.96 seconds
    ...

    ...
     [7457/end/47458 (pid 2206295)] Directory contents of hf_model: ['config.json', 'weights.txt']
    ...

    ...
     [7457/end/47458 (pid 2206295)] Task finished successfully.
    ...

    ...
```

</CodeOutputBlock>

### Loading to specific path


```py title="temp_files/model_load_basic_specific_path.py"
from metaflow import FlowSpec, step, model, current

class ModelSavingFlow(FlowSpec):
    
    @model
    @step
    def start(self):
        import uuid
        # ... Create some model files ...
            
        self.basic_model = current.model.save(
            "./model_directory",
            label="basic_model",
            metadata={
                "version": "1.0",
                "accuracy": 0.95
            }
        )
        
        self.next(self.end)

    @model(load=[("basic_model", "./models/basic_model")]) # Reference the model set to self
    @step  
    def end(self): 
        model_directory = current.model.loaded["basic_model"]
        print("Model Path %s contains contents: %s" % (model_directory, os.listdir(model_directory)))
        print("Loaded model from pathspec: %s" % current.model.loaded.info["basic_model"]["pathspec"])


```

<CodeOutputBlock lang="bash">

```
    ...

    ...

    ...

    ...

    ...

    ...

    ...
     [7458/end/47461 (pid 2206552)] Task is starting.
    ...

    ...
     [7458/end/47461 (pid 2206552)] [@model] Loading Artifact with name `basic_model` [type:model] with key: mf.models/models/artifacts/basic_model_5d1f468cd35142a685de10b117644da4
    ...

    ...
     [7458/end/47461 (pid 2206552)] [@model] Loaded artifact `basic_model[type:model]` in 0.06 seconds
     [7458/end/47461 (pid 2206552)] Model Path ./models/basic_model contains contents: ['config.json', 'weights.txt']
    ...

    ...
     [7458/end/47461 (pid 2206552)] Loaded model from pathspec: ModelSavingFlow/7458/start/47460
    ...

    ...
     [7458/end/47461 (pid 2206552)] Task finished successfully.
    ...

    ...
```

</CodeOutputBlock>

### Loading Models from Keys


```py title="temp_files/model_load_basic_key.py"
from metaflow import FlowSpec, step, model, current

class ModelSavingFlow(FlowSpec):
    
    @model
    @step
    def start(self):
        import uuid
        # ... Create some model files ...
            
        self.basic_model = current.model.save(
            "./model_directory",
            label="basic_model",
            metadata={
                "version": "1.0",
                "accuracy": 0.95
            }
        )
        self.model_key = self.basic_model["key"]
        
        self.next(self.end)

    @model(load=["model_key"]) # Reference the model set to self
    @step  
    def end(self): 
        model_directory = current.model.loaded["model_key"]
        print("Model Path %s contains contents:: %s" % (model_directory, os.listdir(model_directory)))
        print("Loaded model from pathspec: %s" % current.model.loaded.info["model_key"]["pathspec"])


```

<CodeOutputBlock lang="bash">

```
    ...

    ...

    ...

    ...

    ...

    ...

    ...
     [7459/end/47464 (pid 2206798)] Task is starting.
    ...

    ...
     [7459/end/47464 (pid 2206798)] [@model] Loading Artifact with name `model_key` [type:model] with key: mf.models/models/artifacts/basic_model_e1417661935b42e88efc7c14d06a0305
    ...

    ...
     [7459/end/47464 (pid 2206798)] [@model] Loaded artifact `model_key[type:model]` in 0.05 seconds
     [7459/end/47464 (pid 2206798)] Model Path /tmp/metaflow_models_model_key_nhb3wmsb contains contents:: ['config.json', 'weights.txt']
    ...

    ...
     [7459/end/47464 (pid 2206798)] Loaded model from pathspec: ModelSavingFlow/7459/start/47463
    ...

    ...
     [7459/end/47464 (pid 2206798)] Task finished successfully.
    ...

    ...
```

</CodeOutputBlock>

### Explicitly Loading Models


```py title="temp_files/model_load_basic_explicit.py"
from metaflow import FlowSpec, step, model, current

class ModelSavingFlow(FlowSpec):
    
    @model
    @step
    def start(self):
        import uuid
        # ... Create some model files ...
            
        self.basic_model = current.model.save(
            "./model_directory",
            label="basic_model",
            metadata={
                "version": "1.0",
                "accuracy": 0.95
            }
        )
        
        self.next(self.end)

    @model
    @step  
    def end(self): 
        model_directory = current.model.load(self.basic_model)
        print("Model Path %s contains contents: %s" % (model_directory, os.listdir(model_directory)))
        print("Loaded model from pathspec: %s" % self.basic_model["pathspec"])


```

<CodeOutputBlock lang="bash">

```
    ...

    ...

    ...

    ...

    ...

    ...

    ...
     [7460/end/47468 (pid 2207078)] Task is starting.
    ...

    ...
     [7460/end/47468 (pid 2207078)] [@model] Loaded artifact `4ad1a6[type:model]` in 0.05 seconds
    ...

    ...
     [7460/end/47468 (pid 2207078)] Model Path /tmp/metaflow_models_4ad1a6_8tpih9kw contains contents: ['config.json', 'weights.txt']
     [7460/end/47468 (pid 2207078)] Loaded model from pathspec: ModelSavingFlow/7460/start/47467
    ...

    ...
     [7460/end/47468 (pid 2207078)] Task finished successfully.
    ...

    ...
```

</CodeOutputBlock>

### Loading Models Across Flows

#### Loading from Event Triggered Flows

```python
from metaflow import FlowSpec, step, trigger_on_finish, current, model
@trigger_on_finish(flow='ModelRefreshFlow')
class InferenceFlow(FlowSpec):

    @model
    @step
    def start(self):
        print("Triggering run", current.trigger.run)
        model_path = current.model.load(current.trigger.run.data.model_reference)
        # The ModelRefreshFlow contained a `self.model_artifact` set to the return value of 
        # `current.model.save()`/ `current.checkpoint.save()` / `current.huggingface_hub.snapshot_download()`. 
        print("Model path", model_path)
        self.next(self.end)

    @step
    def end(self):
        pass
```

#### Loading Models with Metaflow Client API


```py title="temp_files/model_load_client_api.py"
from metaflow import Flow, current, namespace, model, FlowSpec, step
from metaflow.client import Step, Task
import os

class InferenceFlow(FlowSpec):
    @step
    def start(self):
        # Get model key from previous flow
        run = Flow('ModelSavingFlow').latest_successful_run
        self.upstream_model = run.data.basic_model
        self.next(self.load_model)
    
    @model(load=["upstream_model"])
    @step
    def load_model(self):
        # Decorator-based loading
        model_path = current.model.loaded["upstream_model"]
        print(f"Loaded via decorator to: {model_path} with contents: {os.listdir(model_path)}")
        
        # Manual loading
        manual_path = current.model.load(
            self.upstream_model,
            path="./manual_load"
        )
        print(f"Loaded manually to: {manual_path} with contents: {os.listdir(manual_path)}")
        self.next(self.end)
        
    @step
    def end(self):
        pass

```

<CodeOutputBlock lang="bash">

```
    ...

    ...

    ...

    ...

    ...

    ...

    ...
     [7461/load_model/47471 (pid 2207244)] Task is starting.
    ...

    ...
     [7461/load_model/47471 (pid 2207244)] [@model] Loading Artifact with name `upstream_model` [type:model] with key: mf.models/models/artifacts/basic_model_6483655edd5e44dfb2675968dd23b229
    ...

    ...
     [7461/load_model/47471 (pid 2207244)] [@model] Loaded artifact `upstream_model[type:model]` in 0.04 seconds
    ...

    ...
     [7461/load_model/47471 (pid 2207244)] Loaded via decorator to: /tmp/metaflow_models_upstream_model_bgb_77uz with contents: ['config.json', 'weights.txt']
    ...

    ...
     [7461/load_model/47471 (pid 2207244)] [@model] Loaded artifact `4ad1a6[type:model]` in 0.04 seconds
     [7461/load_model/47471 (pid 2207244)] Loaded manually to: ./manual_load with contents: ['config.json', 'weights.txt']
    ...

    ...
     [7461/load_model/47471 (pid 2207244)] Task finished successfully.
    ...

    ...

    ...

    ...
```

</CodeOutputBlock>

#### Loading Using Parameters

Every model artifact saved with `current.model.save()` is assigned a unique key. This key is present in the `ModelArtifact` dictionary returned by `current.model.save()`. This can also be used to load models across flows.



```py title="temp_files/model_load_key_param.py"
from metaflow import FlowSpec, step, model, Parameter, current

class ModelConsumerFlow(FlowSpec):
    # Model key is the key of the model artifact saved with current.model.save()
    # This key can be accessed via the `key` property of dictionary returned by 
    # `current.model.save()` / `current.checkpoint.save()` / `current.huggingface_hub.snapshot_download()`
    model_key = Parameter('model-key', 
                         help="Key of the model to load")

    @model(load=[("model_key", "./models/consumer")])
    @step
    def start(self):
        # Model is loaded to ./model directory
        import os
        print("Model files:", os.listdir("./models/consumer"))
        print("Loaded model from pathspec: %s" % current.model.loaded.info["model_key"]["pathspec"])
        self.next(self.end)

    @step
    def end(self):
        pass

```


```bash
python temp_files/model_load_key_param.py run --model-key mf.models/models/artifacts/basic_model_828f6108847e44cf8e79d95781434788
```

<CodeOutputBlock lang="bash">

```
    ...

    ...

    ...

    ...

    ...
     [7462/start/47475 (pid 2207435)] Task is starting.
    ...

    ...
     [7462/start/47475 (pid 2207435)] [@model] Loading Artifact with name `model_key` [type:model] with key: mf.models/models/artifacts/basic_model_828f6108847e44cf8e79d95781434788
    ...

    ...
     [7462/start/47475 (pid 2207435)] [@model] Loaded artifact `model_key[type:model]` in 0.09 seconds
    ...

    ...
     [7462/start/47475 (pid 2207435)] Model files: ['config.json', 'weights.txt']
     [7462/start/47475 (pid 2207435)] Loaded model from pathspec: ModelSavingFlow/7083/start/45856
    ...

    ...
     [7462/start/47475 (pid 2207435)] Task finished successfully.
    ...

    ...

    ...

    ...
```

</CodeOutputBlock>

### Loading Models After Flow Execution


```python
from metaflow import Flow 
from metaflow import load_model
run = Flow('ModelSavingFlow').latest_successful_run
upstream_model = run.data.basic_model
load_model(upstream_model, path="./models/notebook-load")
print(
    "Model created for pathspec", run.data.basic_model["pathspec"]
)
print("Model files:", os.listdir("./models/notebook-load"))
```

<CodeOutputBlock lang="python">

```
    Model created for pathspec ModelSavingFlow/7460/start/47467
    Model files: ['config.json', 'weights.txt']
```

</CodeOutputBlock>
